# Entity Resolution (ER) 가이드

이 문서는 Tiny-Graph-RAG에서 동일한 대상을 가리키는 서로 다른 엔티티들을 식별하고 병합하는 **Entity Resolution(ER)** 프로세스를 설명합니다.

## 1. 개요 및 실행 시점

Tiny-Graph-RAG는 문서 추출 단계에서 발생하는 엔티티 중복(별칭, 지시대명사, 오타 등)을 해결하기 위해 하이브리드(규칙 기반 + LLM 기반) ER 시스템을 사용합니다.

- **실행 시점**: `GraphBuilder.build()` 과정의 마지막 단계에서 수행됩니다.
- **수행 방식**: 그래프 구조를 직접 수정하는 **In-place** 방식으로 동작합니다.

## 2. 처리 파이프라인

`LLMEntityResolver.resolve()`는 다음의 5단계를 순차적으로 수행합니다.

1. **Explicit Alias Merge**: `ALIAS_OF`, `SAME_AS`와 같이 명시적인 관계를 가진 엔티티 병합
2. **Contextual Alias Merge**: 강한 문맥적 연관성을 가진 엔티티 병합
3. **Role Bucket Merge**: 미리 정의된 역할군(예: 아내, 환자 등) 기반의 병합
4. **Alias Reassignment**: 잘못 할당된 별칭 관계의 재배치 및 정리
5. **LLM Batch Resolution**: 복잡한 추론이 필요한 엔티티들에 대한 LLM 기반 최종 병합

## 3. 핵심 로직 상세

### 3.1 Person-like 판단
ER은 주로 인물이나 등장인물에 집중합니다. `_is_person_like_entity()`는 다음과 같은 경우를 병합 후보로 판단합니다.
- 엔티티 타입이 `PERSON`인 경우
- 이름이나 설명에 인물을 나타내는 키워드(`아내`, `남편`, `주인`, `의사` 등)가 포함된 경우

### 3.2 휴리스틱 병합 규칙
- **강한 문맥 병합**: 두 엔티티가 `RELATED_TO` 등의 관계를 맺고 있으면서, 공유하고 있는 이웃 노드가 존재할 때 병합을 검토합니다.
- **Role Bucket**: 동일한 역할(예: '김첨지'와 '인력거꾼')을 공유하며 주변 인물 관계가 일치하는 경우 하나로 합칩니다.

### 3.3 LLM 기반 배치 병합
규칙만으로 판단하기 어려운 경우, LLM에게 엔티티들의 메타데이터와 관계 정보를 전달하여 병합 여부를 결정합니다.
- **입력 데이터**: 엔티티 이름, 타입, 설명, 주변 이웃(최대 12개), 소스 청크 텍스트
- **신뢰도 필터링**: LLM이 제안한 병합 그룹 중 신뢰도(`confidence`)가 0.75 이상인 경우만 실제 그래프에 반영합니다.

## 4. 병합 시 주의사항 (Conflict Prevention)

잘못된 병합을 방지하기 위해 다음과 같은 경우에는 병합을 차단합니다.
- 두 엔티티 사이에 명확한 반대 관계(`MARRIED_TO`, `PARENT_OF`, `SIBLING_OF` 등)가 존재하는 경우
- 한 쪽은 인물인데 다른 한 쪽은 장소나 개념인 경우

## 5. 기대 효과

- **그래프 밀도 향상**: 중복 노드가 제거되어 엔티티 간의 연결성이 강화됩니다.
- **검색 정확도 증대**: 다양한 별칭으로 질문하더라도 동일한 노드에 도달하여 정확한 정보를 추출할 수 있습니다.
- **데이터 정제**: 불필요한 노드와 관계가 정리되어 지식 그래프의 품질이 높아집니다.

## 6. 별도 실행 (Batch Execution)

기존에 생성된 그래프 파일들에 대해 일괄적으로 Entity Resolution을 다시 적용하려면 `scripts/apply_er.py`를 사용합니다.

```bash
uv run python scripts/apply_er.py
```

이 스크립트는 `config.yaml`에 설정된 `kg_dir` 내의 모든 `*-KG.json` 파일을 찾아 ER을 수행하고 덮어씁니다.

